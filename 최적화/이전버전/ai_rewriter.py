#!/usr/bin/env python3
"""
Gemini API를 사용한 자연스러운 블로그 원고 재구성
- 원본 구조 최대한 유지
- 어색한 부분만 최소한으로 수정
- 사람이 쓴 느낌 유지
"""

import os
import google.generativeai as genai
from typing import Optional


class AIRewriter:
    """Gemini API를 사용한 원고 자연스럽게 다듬기"""

    def __init__(self, api_key: Optional[str] = None):
        """
        초기화

        Args:
            api_key: Gemini API 키 (없으면 환경변수 GEMINI_API_KEY 사용)
        """
        self.api_key = api_key or os.getenv('GEMINI_API_KEY')

        if not self.api_key:
            raise ValueError(
                "Gemini API 키가 필요합니다. "
                "환경변수 GEMINI_API_KEY를 설정하거나 api_key 파라미터를 전달하세요."
            )

        # Gemini 설정
        genai.configure(api_key=self.api_key)
        # Gemini 2.5 Pro 모델 사용 (사용자 확인)
        self.model = genai.GenerativeModel('gemini-2.5-pro')

    def create_prompt(self, text: str, keyword: str) -> str:
        """재구성 프롬프트 생성 - 어색한 부분만 최소한으로 수정"""

        # 금칙어 리스트 (B열만 - 사용하면 안 되는 단어)
        forbidden_words = [
            "네요", "가격", "광고", "구매", "병원", "진단", "효과", "약효",
            "상담", "시술", "의사", "환자", "판매", "투자", "후회",
            "보험", "재발", "대출", "비용", "의문", "의심",
            "산부인과", "부작용", "홍보성", "의구심", "증상", "증.상"
        ]

        # 사용 가능한 대체어 (C열 이후 - 사용해도 되는 표현)
        allowed_replacements = """
        ✅ 사용 가능한 대체어:
        - 병원 대신 → "병의원", "클리닉", "센터" (OK)
        - 증상 대신 → "증세" (OK) / "현상" (X - 어색)
        - 부작용 대신 → "안 좋은 반응" (OK) / "신체 반응" (X - 의학 논문)
        - 상담 대신 → "문의", "얘기" (OK) / "컨설팅" (X - 병원에서 어색)
        - 효과 대신 → "도움" (OK) / "개선" (X - 단독 사용 시 조사 오류)
        """

        prompt = f"""당신은 블로그 글의 어색한 부분만 살짝 고치는 편집자입니다.

⚠️ **핵심 원칙: 원본을 거의 그대로 두세요!**

# 입력 원고 (기계 치환으로 일부 어색함)
키워드: {keyword}

{text}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🎯 당신의 임무

**원본 문장 구조를 거의 그대로 유지하되, 명백히 어색한 부분만 최소한으로 수정하세요.**

## ❌ 하지 말아야 할 것 (매우 중요!)

1. **원본을 완전히 다시 쓰지 마세요**
   - 문장 순서 바꾸지 말 것
   - 새로운 내용 추가하지 말 것
   - 문장을 합치거나 나누지 말 것
   - 원본의 말투와 리듬 유지

2. **"잘 쓰려고" 하지 마세요**
   - 격식 차리지 말 것
   - 정제하지 말 것
   - 에세이처럼 쓰지 말 것
   - 너무 매끄럽게 만들지 말 것

3. **이런 표현 절대 쓰지 마세요:**
   - ❌ "이런 몸의 변화"
   - ❌ "여성 전문 클리닉" / "여성 관련 보는 곳"
   - ❌ "호르몬 요법" / "호르몬 관리"
   - ❌ "발생 가능성"
   - ❌ "진솔한 조언"
   - ❌ "실천할 수 있는"
   - ❌ "이거 라는" / "이거라는"
   - ❌ "신체 반응" (부작용 대신)
   - ❌ "현상" (증상 대신)
   - ❌ "컨설팅" (병원에서)
   - → 너무 격식적이고 작문 같거나 말이 안 됨!

## ✅ 해야 할 것

**어색한 부분만 최소한으로 수정:**

**예시 1: 조사 오류만 수정**
```
입력: "딱히 큰 개선는 못 봤어요"
출력: "딱히 큰 도움은 못 봤어요"
→ "개선는" → "도움은"만 고침 (나머지 그대로)
```

**예시 2: 부자연스러운 단어만 교체**
```
입력: "이거 그런 모습이 시작된 지 6개월"
출력: "이거 이런 증세가 시작된 지 6개월"
→ "그런 모습" → "이런 증세"만 바꿈 (나머지 그대로)
```

**예시 3: 점(.) 표현만 제거**
```
입력: "부.작용이 무서워서"
출력: "안 좋은 반응이 무서워서"
→ "부.작용" → "안 좋은 반응"만 수정
```

**예시 4: 원본이 자연스러우면 그대로**
```
입력: "진짜 고민돼요"
출력: "진짜 고민돼요"
→ 이미 자연스러우면 그대로 둠!
```

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 📋 수정 규칙

## 1. 금칙어만 교체
❌ **절대 사용 금지 (B열):** {', '.join(forbidden_words)}

{allowed_replacements}

**수정 예시:**
- "증.상" → "증세" (OK) / "현상" (X - 어색)
- "부.작용" → "안 좋은 반응" (OK) / "신체 반응" (X - 의학 논문)
- "병원에서" → "클리닉에서" (OK) / "여성 관련 보는 곳" (X - 말이 안 됨!)
- "상담받았는데" → "문의했는데" (OK) / "컨설팅받았는데" (X - 병원에서 어색)
- "효과가" → "도움이" (OK) / "개선가" (X - 조사 오류)

## 2. 원본 말투 유지
**원본이 이렇게 썼으면 그대로:**
- "진짜", "정말", "너무" → 그대로
- "~어서", "~는데", "~거든" → 그대로
- 반복 표현 → 그대로
- 띄어쓰기 오류 → 그대로 (자연스러우면)

## 3. 사람이 쓴 느낌 유지
- 급하게 쓴 듯한 느낌 → 유지
- 두서없는 느낌 → 유지
- 생각나는 대로 쓴 느낌 → 유지
- 감정적인 표현 → 강화하지 말고 그대로

## 4. 키워드
- 키워드 "{keyword}"는 2-3회
- 나머지는 "이거", "이런 거"
- **원본에서 키워드를 어떻게 썼는지 보고 그대로**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🎯 최종 체크

출력 전 확인:
1. ✅ 원본 문장 구조 거의 그대로 유지했나?
2. ✅ 문장 순서 바꾸지 않았나?
3. ✅ 새로운 내용 추가하지 않았나?
4. ✅ "잘 쓰려고" 정제하지 않았나?
5. ✅ 사람이 쓴 느낌 유지했나?
6. ✅ 금칙어만 교체했나?

**중요: 명백히 어색한 부분(조사 오류, 점 표현, 금칙어)만 고치고 나머지는 원본 그대로 두세요!**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 출력
수정된 원고만 출력하세요. 설명 없이.
"""
        return prompt

    def rewrite(self, text: str, keyword: str) -> str:
        """
        원고의 어색한 부분만 최소한으로 수정

        Args:
            text: 기계 치환된 어색한 원고
            keyword: 키워드

        Returns:
            어색한 부분만 수정한 원고
        """
        try:
            prompt = self.create_prompt(text, keyword)
            response = self.model.generate_content(prompt)

            if response.text:
                return response.text.strip()
            else:
                print("⚠️ AI 재구성 실패: 응답 없음")
                return text

        except Exception as e:
            print(f"⚠️ AI 재구성 오류: {e}")
            return text


def test_rewriter():
    """테스트"""

    # API 키 확인
    api_key = os.getenv('GEMINI_API_KEY')
    if not api_key:
        print("❌ GEMINI_API_KEY 환경변수를 설정해주세요.")
        print("   export GEMINI_API_KEY='your-api-key'")
        return

    rewriter = AIRewriter()

    # 테스트: 어색한 기계 치환 원고
    test_text = """갱년기홍조 때문에 진짜 일상생활이 힘들어서 글 올려봅니다.
이거 그런 모습이 시작된 지 벌써 6개월이 넘었는데,
처음엔 그냥 피로 때문이라고 생각했어요.
이거인 줄 알게 된 건 최근 친구를 통해서였어요.

요즘은 갑자기 얼굴이 화끈거리고 온몸에 열이 오르면서,
사소한 일에도 감정 기복이 엄청 심해졌어요.
밤에 잠도 못 자는 날이 많아져서 만성피로에 시달리고 있고,
'나도 이제 늙었구나' 하는 우울한 생각까지 들더라고요.

클리닉에서 호르몬 치료 안내도 받아봤는데,
암 위험 같은 부.작용이 무서워서 선뜻 시작을 못하겠어요.
석류즙이나 칡즙이 갱년기에 좋다고 해서 꾸준히 먹어봤지만,
딱히 큰 개선는 못 봤어요.
비싼 한약도 먹어봤는데 금액이 부담돼서 중단했고요.

이러다 정말 답답한 마음에 친구한테 하소연하다가,
우연히 이거 라는 걸 알게 됐어요.
건강기능식품이 정말 개선가 있을지 못 믿겠고도 들고,
인터넷엔 소개성 후기들이 많아서 뭘 믿어야 할지 모르겠더라고요.

그래서 실제로 경험해보신 분들의 솔직한 조언을 듣고 싶어서,
이렇게 용기내서 글을 올립니다.
혹시 이거 관리에 도움되는 방법 있으시면 알려주세요.
개선 보신 제품이나 생활습관 개선법 있으면 공유 부탁드려요.

갱년기홍조 말고도 갱년기 그런 모습 완화에 좋은 다른 방법이나,
제가 모르는 더 나은 제품들이 있다면 추천해주시면 감사하겠습니다."""

    keyword = "갱년기홍조"

    print("=" * 80)
    print("AI 최소 수정 테스트")
    print("=" * 80)
    print(f"\n키워드: {keyword}")
    print(f"\n[입력] 어색한 기계 치환 원고:")
    print(test_text)
    print("\n어색한 표현:")
    print("  - '그런 모습이 시작된' ❌")
    print("  - '개선는 못 봤어요' ❌")
    print("  - '개선가 있을지' ❌")
    print("  - '못 믿겠고도 들고' ❌")
    print("  - '부.작용' ❌")
    print("  - '그런 모습 완화에' ❌")

    print(f"\n🤖 AI가 어색한 부분만 최소한으로 수정 중...")
    result = rewriter.rewrite(test_text, keyword)

    print(f"\n[출력] 어색한 부분만 수정한 원고:")
    print("=" * 80)
    print(result)
    print("=" * 80)

    # 검증
    print(f"\n✅ 검증:")

    # 금칙어 확인
    forbidden_check = ["네요", "효과", "약효", "증상", "부작용", "의구심"]
    forbidden_found = False
    for word in forbidden_check:
        if word in result:
            print(f"  ❌ 금칙어 '{word}' 발견됨!")
            forbidden_found = True

    if not forbidden_found:
        print(f"  ✅ 금칙어 없음")

    # 어색한 표현 확인
    awkward_patterns = [
        "그런 모습", "개선는", "개선가", "못 믿겠고도",
        "부.작용", "증.상", "경비이"
    ]
    awkward_found = False
    for pattern in awkward_patterns:
        if pattern in result:
            print(f"  ❌ 어색한 표현 '{pattern}' 여전히 있음!")
            awkward_found = True

    if not awkward_found:
        print(f"  ✅ 어색한 표현 모두 수정됨")

    # 원본 구조 유지 확인
    print(f"\n  원본 문장 수: {len(text.split('.'))} / 수정본 문장 수: {len(result.split('.'))}")
    if abs(len(text.split('.')) - len(result.split('.'))) <= 2:
        print(f"  ✅ 원본 구조 거의 유지됨")
    else:
        print(f"  ⚠️ 원본 구조가 많이 바뀜 (너무 많이 고침)")

    # 키워드 출현 확인
    count = result.count(keyword)
    print(f"  키워드 출현: {count}회 (목표: 2-3회)")


if __name__ == '__main__':
    test_rewriter()
